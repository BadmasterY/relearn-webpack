(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{173:function(e,a,t){"use strict";t.r(a),function(e){t.d(a,"default",(function(){return l}));var n,c=t(85),o=(t(127),t(0),t(86));function r(){return(r=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function s(e,a){if(null==e)return{};var t,n,c=function(e,a){if(null==e)return{};var t,n,c={},o=Object.keys(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||(c[t]=e[t]);return c}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(c[t]=e[t])}return c}(n="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0)&&n(e);"undefined"!=typeof reactHotLoaderGlobal&&reactHotLoaderGlobal.default.signature;var p,b,m={};function l(e){var a=e.components,t=s(e,["components"]);return Object(o.b)("wrapper",r({},m,t,{components:a,mdxType:"MDXLayout"}),Object(o.b)("h2",{className:"__internal",id:"web-workers"},"Web Workers",Object(o.b)("a",r({parentName:"h2"},{href:"#web-workers","aria-hidden":!0,className:"anchor"}),"#")),Object(o.b)("p",null,Object(o.b)("a",r({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API",target:"_blank"}),"Web worker")," 允许您将工作推送到 ",Object(o.b)("inlineCode",{parentName:"p"},"JavaScript")," 的主线程之外执行, 从而使它们便于进行冗长的计算和后台工作。"),Object(o.b)("p",null,"在主线程和 ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 线程之间进行数据通信会带来与通信相关的开销。拆分提供了隔离, 迫使工作人员无法直接操纵用户界面, 仅专注于逻辑。"),Object(o.b)("p",null,"如 ",Object(o.b)("a",r({parentName:"p"},{href:"../Output/targets"}),'"Targets"')," 一章中所述, ",Object(o.b)("inlineCode",{parentName:"p"},"webpack")," 允许您将自己的应用程序构建为 ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 程序。为了更好地理解 ",Object(o.b)("inlineCode",{parentName:"p"},"web worker")," 的概念, 您将学习如何使用 ",Object(o.b)("a",r({parentName:"p"},{href:"https://www.npmjs.com/package/worker-loader",target:"_blank"}),"worker-loader")," 开发一个小型 ",Object(o.b)("inlineCode",{parentName:"p"},"worker"),"。"),Object(o.b)("h3",{className:"__internal",id:"设置-worker-loader"},"设置 worker-loader",Object(o.b)("a",r({parentName:"h3"},{href:"#%E8%AE%BE%E7%BD%AE-worker-loader","aria-hidden":!0,className:"anchor"}),"#")),Object(o.b)("p",null,"首先, 将 ",Object(o.b)("inlineCode",{parentName:"p"},"worker-loader")," 安装到项目中:"),Object(o.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(o.b)("pre",r({parentName:"div"},{className:"language-bash"}),Object(o.b)("code",r({parentName:"pre"},{className:"language-bash"}),Object(o.b)("span",r({parentName:"code"},{className:"token function"}),"npm")," ",Object(o.b)("span",r({parentName:"code"},{className:"token function"}),"add")," worker-loader --develop"))),Object(o.b)("p",null,"您可以不是将加载器定义推送到 ",Object(o.b)("inlineCode",{parentName:"p"},"webpack")," 配置, 而使用内联加载器定义来使演示看起来更加精简。有关替代方法的更多信息, 请参见",Object(o.b)("a",r({parentName:"p"},{href:"../Loading/loader-definitions"}),'"加载器定义"'),"一章。"),Object(o.b)("h3",{className:"__internal",id:"设置-worker"},"设置 worker",Object(o.b)("a",r({parentName:"h3"},{href:"#%E8%AE%BE%E7%BD%AE-worker","aria-hidden":!0,className:"anchor"}),"#")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"worker")," 必须做两件事: 监听消息并做出回应。在这两个事件之间, 它可以执行计算。在这种情况下, 您接受文本数据, 将其附加到 ",Object(o.b)("inlineCode",{parentName:"p"},"worker"),", 然后发送结果:"),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"src/worker.js")),Object(o.b)("div",{className:"rcpress-highlight","data-language":"js"},Object(o.b)("pre",r({parentName:"div"},{className:"language-js"}),Object(o.b)("code",r({parentName:"pre"},{className:"language-js"}),"self",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),Object(o.b)("span",r({parentName:"code"},{className:"token function-variable function"}),"onmessage")," ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=")," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token parameter"}),Object(o.b)("span",r({parentName:"span"},{className:"token punctuation"}),"{")," data",Object(o.b)("span",r({parentName:"span"},{className:"token operator"}),":")," ",Object(o.b)("span",r({parentName:"span"},{className:"token punctuation"}),"{")," text ",Object(o.b)("span",r({parentName:"span"},{className:"token punctuation"}),"}")," ",Object(o.b)("span",r({parentName:"span"},{className:"token punctuation"}),"}")),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")")," ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=>")," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"{"),"\n  self",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),Object(o.b)("span",r({parentName:"code"},{className:"token function"}),"postMessage"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"{")," text",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),":")," text ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"+")," text ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"}"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"}"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";")))),Object(o.b)("h3",{className:"__internal",id:"设置主机"},"设置主机",Object(o.b)("a",r({parentName:"h3"},{href:"#%E8%AE%BE%E7%BD%AE%E4%B8%BB%E6%9C%BA","aria-hidden":!0,className:"anchor"}),"#")),Object(o.b)("p",null,"主机必须实例化 ",Object(o.b)("inlineCode",{parentName:"p"},"worker"),", 然后与它通信。这个想法几乎是一样的, 只有主机拥有控制权:"),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"src/component.js")),Object(o.b)("div",{className:"rcpress-highlight","data-language":"js"},Object(o.b)("pre",r({parentName:"div"},{className:"language-js"}),Object(o.b)("code",r({parentName:"pre"},{className:"language-js"}),Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"import")," Worker ",Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"from")," ",Object(o.b)("span",r({parentName:"code"},{className:"token string"}),'"worker-loader!./worker"'),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n\n",Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"export")," ",Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"default")," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")")," ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=>")," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"const")," element ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=")," document",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),Object(o.b)("span",r({parentName:"code"},{className:"token function"}),"createElement"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token string"}),'"h1"'),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n  ",Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"const")," worker ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=")," ",Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"new")," ",Object(o.b)("span",r({parentName:"code"},{className:"token class-name"}),"Worker"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n  ",Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"const")," state ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=")," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"{")," text",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),":")," ",Object(o.b)("span",r({parentName:"code"},{className:"token string"}),'"foo"')," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"}"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n\n  worker",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),Object(o.b)("span",r({parentName:"code"},{className:"token function"}),"addEventListener"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token string"}),'"message"'),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),",")," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token parameter"}),Object(o.b)("span",r({parentName:"span"},{className:"token punctuation"}),"{")," data",Object(o.b)("span",r({parentName:"span"},{className:"token operator"}),":")," ",Object(o.b)("span",r({parentName:"span"},{className:"token punctuation"}),"{")," text ",Object(o.b)("span",r({parentName:"span"},{className:"token punctuation"}),"}")," ",Object(o.b)("span",r({parentName:"span"},{className:"token punctuation"}),"}")),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")")," ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=>")," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"{"),"\n    state",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),"text ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=")," text",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n    element",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),"innerHTML ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=")," text",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n  ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"}"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n\n  element",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),"innerHTML ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=")," state",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),"text",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n  element",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),Object(o.b)("span",r({parentName:"code"},{className:"token function-variable function"}),"onclick")," ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=")," ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")")," ",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),"=>")," worker",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),Object(o.b)("span",r({parentName:"code"},{className:"token function"}),"postMessage"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"("),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"{")," text",Object(o.b)("span",r({parentName:"code"},{className:"token operator"}),":")," state",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"."),"text ",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"}"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),")"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n\n  ",Object(o.b)("span",r({parentName:"code"},{className:"token keyword"}),"return")," element",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),"}"),Object(o.b)("span",r({parentName:"code"},{className:"token punctuation"}),";")))),Object(o.b)("p",null,"有这两个设置之后, ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 就可以工作了。当点击文本时, 它应该在 ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 完成其执行时改变应用程序状态。为了演示 ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 的异步特性, 可以尝试在其中加入延迟, 然后看看会发生什么。"),Object(o.b)("h3",{className:"__internal",id:"在主机与-worker-之间共享信息"},"在主机与 worker 之间共享信息",Object(o.b)("a",r({parentName:"h3"},{href:"#%E5%9C%A8%E4%B8%BB%E6%9C%BA%E4%B8%8E-worker-%E4%B9%8B%E9%97%B4%E5%85%B1%E4%BA%AB%E4%BF%A1%E6%81%AF","aria-hidden":!0,className:"anchor"}),"#")),Object(o.b)("p",null,"由于序列化的成本, 在主机和 ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 线程之间传递数据可能会很昂贵。通过使用 ",Object(o.b)("a",r({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers#Passing_data_by_transferring_ownershi",target:"_blank"}),"Transferable 对象"),"可以将成本降到最低, 并且将来, 借助 ",Object(o.b)("a",r({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer",target:"_blank"}),"SharedArrayBuffer")," 可以共享数据。"),Object(o.b)("h3",{className:"__internal",id:"其他选择"},"其他选择",Object(o.b)("a",r({parentName:"h3"},{href:"#%E5%85%B6%E4%BB%96%E9%80%89%E6%8B%A9","aria-hidden":!0,className:"anchor"}),"#")),Object(o.b)("p",null,Object(o.b)("a",r({parentName:"p"},{href:"https://www.npmjs.com/package/webworkify-webpack",target:"_blank"}),"webworkify-webpack")," 的 ",Object(o.b)("inlineCode",{parentName:"p"},"API")," 允许您将 ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 用作常规 ",Object(o.b)("inlineCode",{parentName:"p"},"JavaScript")," 模块, 因为您可以避免示例解决方案中可见的 ",Object(o.b)("inlineCode",{parentName:"p"},"self")," 需求。 ",Object(o.b)("a",r({parentName:"p"},{href:"https://github.com/developit/workerize-loader",target:"_blank"}),"workerize-loader")," 和 ",Object(o.b)("a",r({parentName:"p"},{href:"https://github.com/GoogleChromeLabs/worker-plugin",target:"_blank"}),"worker-plugin")," 是其他 ",Object(o.b)("inlineCode",{parentName:"p"},"api")," 略有不同的选项。"),Object(o.b)("p",null,Object(o.b)("a",r({parentName:"p"},{href:"https://threads.js.org/",target:"_blank"}),"threads.js")," 为更复杂的设置提供了一个全面的解决方案, 并且包括开箱即用的可观察对象和线程池等功能。有一个自定义 ",Object(o.b)("a",r({parentName:"p"},{href:"https://github.com/andywer/threads-plugin",target:"_blank"}),"threads-plugin"),", 可用于将其与 ",Object(o.b)("inlineCode",{parentName:"p"},"webpack")," 集成。"),Object(o.b)("h3",{className:"__internal",id:"结论"},"结论",Object(o.b)("a",r({parentName:"h3"},{href:"#%E7%BB%93%E8%AE%BA","aria-hidden":!0,className:"anchor"}),"#")),Object(o.b)("p",null,"要注意的关键是, ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 无法访问DOM。您可以在 ",Object(o.b)("inlineCode",{parentName:"p"},"worker")," 线程中执行计算和查询, 但是它不能直接操作用户界面。"),Object(o.b)("p",null,"回顾一下:"),Object(o.b)("ul",null,Object(o.b)("li",r({parentName:"ul"},{className:"__internal"}),Object(o.b)("inlineCode",{parentName:"li"},"Web Worker")," 允许您将工作推出浏览器的主线程。这种拆分是有价值的, 特别是在性能成为问题的情况下。"),Object(o.b)("li",r({parentName:"ul"},{className:"__internal"}),Object(o.b)("inlineCode",{parentName:"li"},"Web Worker")," 无法操纵 ",Object(o.b)("inlineCode",{parentName:"li"},"DOM"),"。相反, 最好将它们用于冗长的计算和请求。"),Object(o.b)("li",r({parentName:"ul"},{className:"__internal"}),Object(o.b)("inlineCode",{parentName:"li"},"Web Worker")," 提供的隔离可用于架构上的好处。它迫使程序员留在特定的沙箱中。"),Object(o.b)("li",r({parentName:"ul"},{className:"__internal"}),"与 ",Object(o.b)("inlineCode",{parentName:"li"},"Web Worker")," 进行通信会带来开销, 这使他们变得不那么实用。随着规范的发展, 将来可能会改变。")),Object(o.b)("p",null,"您将在下一章中了解国际化。"))}l.isMDXComponent=!0,l=Object(c.hot)(e)(l),(p="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0)&&(p.register(m,"layoutProps","/Users/yuzhoujie/Desktop/work/webpack-book-china/docs/webpack/Techniques/web-workers.md"),p.register("wrapper","MDXLayout","/Users/yuzhoujie/Desktop/work/webpack-book-china/docs/webpack/Techniques/web-workers.md"),p.register(l,"MDXContent","/Users/yuzhoujie/Desktop/work/webpack-book-china/docs/webpack/Techniques/web-workers.md")),(b="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0)&&b(e)}.call(this,t(21)(e))}}]);